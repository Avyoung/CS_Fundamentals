# 网络层的基础知识
## 路由器和交换机的区别
- 路由在网络层，交换机在数据链路层。
- 交换机转发依赖MAC地址，路由器转发依赖IP地址；（所以交换机属于硬件类别，而路由属于软件）
- 交换机主要功能使构建局域网，而路由是将构建好的局域网连接起来，或者接入Internet；
- 传统的交换机只能分割冲突域（Hub不能隔离冲突域），不能分割广播域；路由可以分割广播域。由交换机连接的网段仍属于同一个广播域，广播数据包会在交换机连接的所有网段上传播，在某些情况下会导致通信拥挤和安全漏洞。连接到路由器上的网段会被分配成不同的广播域，广播数据不会穿过路由器。虽然第三层以上交换机具有VLAN功能，也可以分割广播域，但是各子广播域之间是不能通信交流的，它们之间的交流仍然需要路由器。
- 路由器提供了防火墙的服务：路由器仅仅转发特定地址的数据包，不传送不支持路由协议的数据包传送和未知目标网络数据包的传送，从而可以防止广播风暴。
- 路由器相对于交换机来说，是包含交换机的功能。交换机常常的用途是用来扩展网络接口，比如一个情景是只有两个网口，但是却有四台电脑需要上网，这时候就面临网口不足的情况，这时候就可以买一台交换机来扩展接口。总结来说交换机起到的是增加网口的作用。而路由器则不同，路由器不但起到了扩展网口，还可以一个账号，实现多人多机上网的作用（NAT）。




## 转发和路由选择的区别
网络层主要的两种功能：转发和路由选择
转发：在单一的路由器中从一条入链路到一条出链路的传送，是路由器的本地操作。（刷的一下就完成了）
每个路由器都有一张转发表，路由器通过检查到达分组首部值来之处该分组将被转发的路由器的输出链路接口。

 
路由选择：涉及一个网络的所有路由器，它们经路由选择协议共同交互，以决定分组从源到目的节点所采用的路径。（类似于从一个城市到另一个城市的路线规划）

## 路由器的工作原理
路由器由以下四个部分构成
- 输入端口
- 交换结构
- 输出端口
- 路由选择处理器
1. 输入端口：
（1） 执行一条输入的物理链路与路由器相连接的物理层功能；
（2）入链路端的数据链路层交互的数据链路层功能
（3） 查询功能，查询转发表来决定输出端口
2. 交换结构：
（1）把输入端口和输出端口相连，有以下三种类型的交换结构
（2）经内存交换（CPU计算）
（3）总线交换（输入端口经一条总线与输出端口相连，多个分组同时到达路由器，即时有不同输出端口，除了一个分组外，其余必须等待，相当于一条路上只能跑一辆汽车）
经互联网络相连

3. 输出端口
存储从交换结构接受的分组，并通过执行必要的链路层和物理层在输入链路上传输这些分组。
在这里可能出现丢包现象，当n个输入端口同时向一个输出端口发送数据，最终会耗尽输出端口的内存。
在输出端口可能会排队，所以在输出端口会有一个分组调度程序，如先来先服务（FCFS）,或者奇特的调度规则。
4. 路由选择处理器
执行路由选择协议，维护路由选择表以及链路状态信息，为路由器计算转发表。

**前三部分构成了转发的功能，通常是用硬件实现，比软件快**


# IP协议
### IPV4数据报格式

 版本号：IPV4还是6

首部长度：一般来说是20字节（选项一般没有）

服务类型（TOS）：将实时数据报(如电话应用)和非实时流量（如FTP）分开

数据报长度：包括首部和数据，16比特，理论最大长度为65535字节

**标识、标志，偏移**:与数据分片有关，接收方需要根据这些信息来进行判断和重组。

寿命（TTL）：每当数据报由一台路由器处理是，该字段减一，若TTL为0,则必须丢弃。

**上层协议：**6：数据部分交给TCP  17：数据交给UDP

首部校验和：本地算一次存起来，接收方再算一次，当结果不一致时丢弃。
*经常被问的问题，为什么TCP/IP在运输层和网络层都会执行差错检测？*
1. IP直对首部进行检验和，而TCP/UDP检验是对整个TCP/UDP报文段进行的
2. IP能够携带不一定要传给TCP/UDP的数据（也可以承载ICMP报文）

## IP数据分片
并不是所有的链路层协议都能承载相同长度的网络层分组。如以太网帧能够承载不超过1500字节的数据。
所以当一个路由器收到一个IP数据报时，转发的时候发现输出链路的MTU < IP数据报 的大小，便会出现数据分片，然后在目的主机执行重装的任务。IPV4数据报中的标识就是来重装的。
当需要分片时，发送主机将为它发送的每个数据报的标志号加1，接收方再进行重组。由于IP协议是不可靠的服务，所以可能有些分片永远到不了，所以为了告诉接收方已经发送完了，最后一个片的标志比特被设为0，而所有其他的标志比特设为1.只有在目的主机已经完全重构为初始ip数据报时，才会被传递给目的地的运输层，否则将被丢弃。为什么说TCP是可靠的呢？因为TCP可以让发送方再次重发，以恢复这次丢包。
但是分片也是很费时间的，所以可能会用于生成致命的Dos攻击，通过发送奇怪的分片，如发送一系列没有标志位0的分片，或者偏移不能适当排列起来。。。。IPV6废止了分片，从而简化了IP分组的处理，并使得IP不太容易受到攻击。

 

## IPV4编址
从前面的IP数据报格式可以知道，每个IP地址的长度为32比特，2^32约等于40亿个可能的IP地址。如193.32.216.9----》点分十进制法
接口地址和子网。
子网：分开主机和路由器的每个接口，产生几个隔离的网络岛，使用接口端接这些隔离的网络的端点。这些隔离的网络中的每一个都叫做一个子网。

 
### 无类别域间路由选择（CIDR）- 一种编址方式
将地址分为网络号+主机号
a.b.c.d/x,x表示第一不部分的比特数。剩余的32-x为分给该组织的内部设备的。
在CIDR之前，采用的是分类编址。网络号部分被限制为8、16、24比特的子网地址，分别称为A B C三类网络。
分类编址的缺点：一个C类地址只能容纳2^8 - 2= 254台主机（全1为广播，全0为主机），B类地址可以65534台主机，如果给2000台分配C不够，分配B浪费。
有个机构专门负责IP地址分配和DNS根服务器

### 获取主机地址：动态主机配置协议（DHCP）
某个组织获得了一块地址，采用DHCP协议允许主机自动获取一个IP地址。这种地址通常都是临时的。如一个小区有2000个客户，但是不会超过400个人同时在线，所以没有必要申请一个2048的地址，只用申请一个512的地址a.b.c.d/23就够了。
当一台主机加入时，在地址池中分配一个地址给它。离开时，再将地址回收到地址池中。DHCP服务器。
DHCP的步骤
- DHCP服务器发现：新到的主机发送一条DHCP发现报文来广播自己的到来。
- DHCP服务器提供（可能有多个DHCP服务器进行响应，下一步中客户端择优选取）
- DHCP请求
- DHCP ack



### NAT(网络地址)
用于解决当分配的地址不够用了的情况。
NAT转换表
将WAN端的138.76.29.7,5001 映射到LAN端的10.0.0.1,3345

### 因特网控制报文协议：ICMP
主机和路由去来彼此沟通网络层信息，最典型的应用是差错报告。如运行一个Telnet会话时出现“目的网络不可达”之类的错误报文

## IPV6

 
- 扩大了地址容量 ：从32比特增加到128比特
- 简化了首部，40字节
- 流标签与优先级，类似于IPV4中的TOS
- 有效荷载长度：首部后的数据的长度
- 下一个首部：交给UDP还是TCP
- 跳限制，没转发一次，跳限制减1，当为0时丢弃

分片/组装没有了，IPV6不允许在中间路由进行分片与重新组装，这种操作只能在源与目的上执行。当数据报太大时直接丢弃。

# 路由选择算法
最短路径，最小生成树之类的算法。Prim，Dijkstra算法之类

# 广播和多播
广播：从源节点到网络中的所有其他节点交付分组的服务。
多播：使源节点能够像其他网络节点的一个子集发送分组的副本。

## 广播路由算法
### N次单播
源节点向每个目标节点都发送一次信息，可以通过中间的某个节点复制副本并转发。其实并不知道所有的目的地的地址？尴尬了不是。。。。所以代价是很高的

### 无控制洪泛
洪泛：源节点向它所有的邻居发送分组的副本。
缺点：如果出现环，则造成广播风暴。

### 受控洪泛
- 序号控制洪泛：源节点将其地址以及广播序号放入广播分组，再向他的所有邻居发送该分组，每个节点维护一个序号列表。当节点收到一个广播分组时，首先看它在不在列表中，如果在丢弃；不在复制该分组并向该节点的所有邻居转发。
- 反向路径转发：当一台路由器接收到具有给定原地址的广播分组时，仅当该分组到达的链路正好是位于它自己返回其源的最短单播路径上，才向其他所有出链路传输报文。

### 生成树广播
首先对网络节点构造出一棵生成树。当一个源节点要发送一个广播分组时，向所有属于该生成树的特定链路发送分组。

## 多播
怎样标识多播分组的接收方，怎样为发送这些接收方的分组编址？通常使用间接地址。
间接地址：用一个标识来表示一组接收方。如何分组？新主机如何加入分组？任何主机都能加入分组么？
管理方法：因特网组管理协议（IGMP）+ 多播路由选择协议
### IGMP----管理一个多播分组的协议
IGMP工作在主机和与其直接相连的路由器之间（第一跳路由器），IGMP报文也是封装在一个IP数据报中，使用的IP协议号是2.一台路由器向该局域网内所有主机发送一个membership_query报文，以确定该局域网内已经加入多播组集合的主机。主机采用membership_report报文响应。或者主机直接产生membership_report报文主动通知路由器，而不用等待。离开多播分组时。主机可以发送一个leave_group报文（可选的），也可以选择不回应membership_query自动脱组。

### 多播路由选择协议
- 使用一棵组共享树实现多播路由选择。（和广播的生成树广播类似）
- 使用一棵基于源的树的多播路由选择，和反向路径转发（RPF）类似，解决RPF时会受到不想要的多播分组------>##剪枝##

# ARP
ARP协议的目的是询问子网上所有其他主机和路由器，以确定需要解析IP地址的那个MAC地址。
每台主机或路由器在内存中都有一个ARP表，包含IP地址和MAC地址的对应关系，以及TTL。
在一个局域网内，如果一台主机A向另一台主机B发送数据，如果B的ip地址正好存在在ARP表中，结束。
如果不存在，发送方构造一个ARP分组（包括发送和接收的IP地址，及MAC地址）ARP查询分组和响应分组都具有相同的结构。发送方提示适配器使用MAC广播地址（FF-FF-FF-FF-FF-FF）将该帧传入子网。包含该ARP查询的帧能被自网上的所有适配器接收到，这些ARP模块中的每个都检查它的IP地址是否与ARP分组中的目的IP地址向匹配。匹配则发回一个相应ARP，查询主机更新它的ARP表。

如果需要发送数据报到子网以外
1. 发送方将发送一条IP数据报，MAC地址为其所在路由器的MAC地址。（通过ARP协议知道路由器的MAC地址）
2. 路由器发现是链路层帧向它进行寻址的，因此把这个帧传递给路由器的网络层。
3. 通过转发表寻找输出端口，并进入到目的地的子网中，通过ARP解析获得MAC地址发送数据报。
